import client
import random
import sys

BASE_URL = 'http://pac.bouillaguet.info/TP4/shifumi-deathmatch'

g = 232386537238907791268676042647608689791609404011663670320771614668188559425342888776280198377229604159560737294145249289693953159720482986968552843382473032392010435224388872495850924407503452861318116481530460023386052524403127793403597266956126777982482971270114475211223098477253522184515625768275017513145989999259525574529256208947256329858302600272132795160122438201736491029162297284067075285291721602980652088719052432470120591373776839741682613832535702765562847848796173429903729326950837195291626675943558617173972013184736215341734771750657786191718222335643731318578295651550266826939343489674941557427
p = 19621548278834791921668721501976461629504476520657659053906196608708978743510454672450244994252353949714779053256829367806674095667286043674296881025526158533044979737097551221749079201334172347066680164380378008208413645119667564002570398540999356005210774146062236210747849638099235214033217909759940079369061622674561847525745060310532241718891712835314118636540636974352116452114831867834811426436416644741643017579629092134226319844063317950966812454032950169458225170149104459007190271921151246394097327620580237278324280506327813290314207461989566282665745132843141207731154193206104916623842658011966591592607

PIERRE = 88275625857605
FEUILLE = 19779480974019653
CISEAUX = 18939445432636760

# retourne 1 si x est pair
def legendre(a, p):
    tmp = (p - 1) // 2
    return pow(a, tmp, p)

def XGCD(a, b):
    u = (1, 0)
    v = (0, 1)

    while(b != 0):
        q, r = divmod(a, b)
        a = b
        b = r
        tmp = (u[0] - q * v[0], u[1] - q * v[1])
        u = v
        v = tmp

    return a, u[0], u[1]

if __name__ == '__main__':
    print('#' * 80)
    print('Start')
    server = client.Server(BASE_URL)

    g = 232386537238907791268676042647608689791609404011663670320771614668188559425342888776280198377229604159560737294145249289693953159720482986968552843382473032392010435224388872495850924407503452861318116481530460023386052524403127793403597266956126777982482971270114475211223098477253522184515625768275017513145989999259525574529256208947256329858302600272132795160122438201736491029162297284067075285291721602980652088719052432470120591373776839741682613832535702765562847848796173429903729326950837195291626675943558617173972013184736215341734771750657786191718222335643731318578295651550266826939343489674941557427
    p = 19621548278834791921668721501976461629504476520657659053906196608708978743510454672450244994252353949714779053256829367806674095667286043674296881025526158533044979737097551221749079201334172347066680164380378008208413645119667564002570398540999356005210774146062236210747849638099235214033217909759940079369061622674561847525745060310532241718891712835314118636540636974352116452114831867834811426436416644741643017579629092134226319844063317950966812454032950169458225170149104459007190271921151246394097327620580237278324280506327813290314207461989566282665745132843141207731154193206104916623842658011966591592607

    if(len(sys.argv) == 2):
        server.query('/insert-coin/sommerard')

    for i in range(100):
        print('-' * 80)

        x = random.randint(1, p-1)
        h = pow(g, x, p)

        # print(legendre(h, p))
        # if(legendre(h, p) == 1):
        #     x -= 1
        #     h = pow(g, x, p)

        response = server.query('/start/sommerard')
        #print(response)

        foobar = response['foobar']
        k = random.randint(2, p-1)

        tmp, _, _ = XGCD(k, p-1)
        while(tmp != 1):
            k = random.randint(2, p-1)
            tmp, _, _ = XGCD(k, p-1)

        m = PIERRE
        move = 'PIERRE'

        if 'commitment' in response:
            advr = response['commitment']['ciphertext'][0]
            advs = response['commitment']['ciphertext'][1]
            advg = response['commitment']['PK']['g']
            advp = response['commitment']['PK']['p']
            advh = response['commitment']['PK']['h']

            m = FEUILLE
            move = 'FEUILLE'

            if(legendre(advh, advp) == 1):
                if(legendre(advr, advp) == 1):
                    if(legendre(advs, advp) == 1):
                        print('Predict: CISEAUX')
                        m = PIERRE
                        move = 'PIERRE'

        gk = pow(g, k, p)
        hk = pow(h, k, p)
        mhk = (m * hk) % p
        ciphertext = [gk, mhk]
        commitment = { 'PK': { 'p': p, 'h': h, 'g': g }, 'ciphertext': ciphertext }

        parameters = { 'foobar': foobar, 'commitment': commitment }
        response = server.query('/move', parameters)
        # print(response)

        barfoo = response['barfoo']
        parameters = { 'move': move, 'k': k, 'barfoo': barfoo }
        response = server.query('/result', parameters)
        print('Me move:', move)
        print('Server move:', response['move'])
        print('Result:', response['round-status'])
        print('-' * 40)

        response = server.query('/status/sommerard')
        print('Server:', response['mine'])
        print('Me:', response['yours'])
